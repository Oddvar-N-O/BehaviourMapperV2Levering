<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script>
        function choosenOne () {
            console.log("Deeeep");
            map.once('rendercomplete', function () {
              var mapCanvas = document.createElement('canvas');
              var size = map.getSize();
              console.log("size " + size)
              mapCanvas.width = size[0];
              mapCanvas.height = size[1];
              var mapContext = mapCanvas.getContext('2d');
              Array.prototype.forEach.call(
                document.querySelectorAll('.ol-layer canvas'),
                function (canvas) {
                  if (canvas.width > 0) {
                    console.log("Width > 0");
                    var opacity = canvas.parentNode.style.opacity;
                    mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
                    var transform = canvas.style.transform;
                    // Get the transform parameters from the style's transform matrix
                    var matrix = transform
                      .match(/^matrix\(([^\(]*)\)$/)[1]
                      .split(',')
                      .map(Number);
                    // Apply the transform to the export map context
                    console.log("has transformed.");
                    CanvasRenderingContext2D.prototype.setTransform.apply(
                      mapContext,
                      matrix
                    );
                    console.log("Set MapContext");
                    mapContext.drawImage(canvas, 0, 0);
                  }
                }
              );
              if (navigator.msSaveBlob) {
                console.log("SaveBlob");
                // link download attribuute does not work on MS browsers
                navigator.msSaveBlob(mapCanvas.msToBlob(), 'map.png');
              } else {
                var link = document.getElementById('image-download');
                link.href = mapCanvas.toDataURL();
                link.click();
              }
            });
            map.renderSync();
          }
    </script>
    <!--Include OL-->
    <title>OpenLayers example</title>
  </head>
  <body>
    <h2>My Map</h2>
    <!--Create a div with id map-->
    <div id="map" class="map"></div>
    <!--Create map that points to "map"-->
    <script src="kart.js"></script>

    <button onclick="choosenOne()">Take screenshot</button>
    <!--<a id="export-png"><i></i> Download PNG</a>
    <a id="image-download" download="map.png"></a>-->
    <a id="image-download" download="map.png"></a>
    <!-- <img id="image-download" width="75%" class="screen"> -->
  </body>
</html>